# INSTRUCT.md

**Project setup and development guide for Claude agents working with TheSkyscape DevTools applications**

## Quick Start with CLI Tools

The fastest way to get started is using the CLI tools:

```bash
# Clone and build DevTools
git clone https://github.com/The-Skyscape/devtools
cd devtools
make build

# Create new application
./build/create-app my-todo-app
cd my-todo-app

# Set required environment variable
export AUTH_SECRET="your-super-secret-jwt-key"

# Run the application
go run .
```

This generates a complete todo application with authentication, database, and HTMX-powered UI.

## Project Overview

This application is built using **TheSkyscape DevTools**, a Go toolkit for cloud-native applications with built-in authentication, database management, container orchestration, and multi-cloud deployment capabilities.

## Architecture

Applications generated by `create-app` follow this structure:

```
project-root/
‚îú‚îÄ‚îÄ controllers/                 # HTTP handlers with factory functions
‚îÇ   ‚îú‚îÄ‚îÄ home.go                 # Home page controller
‚îÇ   ‚îî‚îÄ‚îÄ todos.go                # Todo CRUD controller
‚îú‚îÄ‚îÄ models/                      # Database models and business logic
‚îÇ   ‚îú‚îÄ‚îÄ database.go             # Global DB, Auth, and repository setup
‚îÇ   ‚îî‚îÄ‚îÄ todo.go                 # Todo model with Table() method
‚îú‚îÄ‚îÄ views/                       # Page templates (embedded at build time)
‚îÇ   ‚îú‚îÄ‚îÄ home.html               # Home page template
‚îÇ   ‚îú‚îÄ‚îÄ todos.html              # Todo list template
‚îÇ   ‚îú‚îÄ‚îÄ layout.html             # Shared layout components
‚îÇ   ‚îî‚îÄ‚îÄ partials/               # Reusable template components
‚îú‚îÄ‚îÄ main.go                      # Application entry point with embedded views
‚îú‚îÄ‚îÄ go.mod                       # Go dependencies
‚îî‚îÄ‚îÄ go.sum
```

## Development Patterns

### 1. Database Models (`models/`)

**Global Setup (`models/database.go`):**
```go
package models

import (
    "github.com/The-Skyscape/devtools/pkg/application"
    "github.com/The-Skyscape/devtools/pkg/authentication"
    "github.com/The-Skyscape/devtools/pkg/database"
    "github.com/The-Skyscape/devtools/pkg/database/local"
)

var (
    DB    = local.Database("app.db")
    Auth  = authentication.Manage(DB)
    Todos = database.Manage(DB, new(Todo))
)
```

**Model Definition (`models/todo.go`):**
```go
package models

import "github.com/The-Skyscape/devtools/pkg/application"

type Todo struct {
    application.Model
    Title     string
    Completed bool
}

func (*Todo) Table() string { return "todos" }
```

### 2. Controllers (`controllers/`)

Controllers implement factory functions and required methods:

```go
package controllers

import (
    "errors"
    "net/http"
    "your-app/models"
    "github.com/The-Skyscape/devtools/pkg/application"
)

// Factory function returning controller name and instance
func Todos() (string, *TodosController) {
    return "todos", &TodosController{}
}

type TodosController struct {
    application.BaseController
}

// Setup registers routes when application starts
func (c *TodosController) Setup(app *application.App) {
    c.BaseController.Setup(app)
    app.Serve("GET /todos", "todos.html", models.Auth.Required)
    app.ProtectFunc("POST /todos", c.createTodo, models.Auth.Required)
    app.ProtectFunc("PUT /todos/{id}/toggle", c.toggleTodo, models.Auth.Required)
    app.ProtectFunc("DELETE /todos/{id}", c.deleteTodo, models.Auth.Required)
}

// Handle returns controller instance for each request
func (c *TodosController) Handle(r *http.Request) application.Controller {
    c.Request = r
    return c
}

// Template method: accessible as {{todos.AllTodos}} in views
func (c *TodosController) AllTodos() ([]*models.Todo, error) {
    return models.Todos.Search("")
}

// HTTP handler methods
func (c *TodosController) createTodo(w http.ResponseWriter, r *http.Request) {
    title := r.FormValue("title")
    if title == "" {
        c.Render(w, r, "error-message.html", errors.New("title is required"))
        return
    }

    todo := &models.Todo{Title: title}
    if err := models.Todos.Insert(todo); err != nil {
        c.Render(w, r, "error-message.html", err)
        return
    }

    c.Refresh(w, r) // HTMX page refresh
}

func (c *TodosController) toggleTodo(w http.ResponseWriter, r *http.Request) {
    id := r.PathValue("id")
    todo, err := models.Todos.Get(id)
    if err != nil {
        c.Render(w, r, "error-message.html", err)
        return
    }

    todo.Completed = !todo.Completed
    if err := models.Todos.Update(todo); err != nil {
        c.Render(w, r, "error-message.html", err)
        return
    }

    c.Refresh(w, r)
}

func (c *TodosController) deleteTodo(w http.ResponseWriter, r *http.Request) {
    id := r.PathValue("id")
    todo, err := models.Todos.Get(id)
    if err != nil {
        c.Render(w, r, "error-message.html", err)
        return
    }

    if err := models.Todos.Delete(todo); err != nil {
        c.Render(w, r, "error-message.html", err)
        return
    }

    c.Refresh(w, r)
}
```

### 3. Main Application (`main.go`)

```go
package main

import (
    "embed"
    "os"
    "cmp"
    "your-app/controllers"
    "your-app/models"
    "github.com/The-Skyscape/devtools/pkg/application"
)

//go:embed all:views
var views embed.FS

func main() {
    port := cmp.Or(os.Getenv("PORT"), "5000")
    
    application.Serve(views,
        application.WithController("auth", models.Auth.Controller()),
        application.WithController(controllers.Home()),
        application.WithController(controllers.Todos()),
        application.WithDaisyTheme("corporate"),
        application.WithPort(port),
    )
}
```

### 4. Templates (`views/*.html`)

Templates use unique filenames and access controller methods:

**Layout (`views/layout.html`):**
```html
{{define "layout/start"}}
<!DOCTYPE html>
<html data-theme="{{theme}}" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App - TheSkyscape</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-base-200 min-h-screen">
    <div class="container mx-auto px-4 py-8">
{{end}}

{{define "layout/end"}}
    </div>
</body>
</html>
{{end}}
```

**Todo List (`views/todos.html`):**
```html
{{template "layout/start"}}

<div class="card bg-base-100 shadow-lg mb-8">
    <div class="card-body">
        <h2 class="card-title">Add New Todo</h2>
        <form hx-post="/todos" class="space-y-4">
            <input name="title" type="text" placeholder="What do you need to do?" 
                   class="input input-bordered w-full" required>
            <button type="submit" class="btn btn-primary">Add Todo</button>
        </form>
    </div>
</div>

<div class="space-y-3">
    {{range todos.AllTodos}}
        {{template "partials/todos-item.html" .}}
    {{else}}
        <p class="text-center text-base-content/50">No todos yet! Add one above.</p>
    {{end}}
</div>

{{template "layout/end"}}
```

**Todo Item Partial (`views/partials/todos-item.html`):**
```html
<div class="flex items-center justify-between p-4 border rounded-lg {{if .Completed}}opacity-60{{end}}">
    <div class="flex items-center space-x-3">
        <button hx-put="/todos/{{.ID}}/toggle" 
                class="checkbox {{if .Completed}}checkbox-success{{end}}" 
                {{if .Completed}}checked{{end}}>
        </button>
        <span class="{{if .Completed}}line-through{{end}}">{{.Title}}</span>
    </div>
    <button hx-delete="/todos/{{.ID}}" hx-confirm="Are you sure?"
            class="btn btn-ghost btn-sm text-error">üóëÔ∏è</button>
</div>
```

## Environment Configuration

Set these environment variables before running:

```bash
# Required
export AUTH_SECRET="your-jwt-secret-key"

# Optional application settings
export PORT="5000"                        # Server port (default: 5000)
export THEME="corporate"                  # DaisyUI theme

# Optional: SSL certificates
export CONGO_SSL_FULLCHAIN="/path/to/fullchain.pem"
export CONGO_SSL_PRIVKEY="/path/to/privkey.pem"

# Cloud deployment (for launch-app tool)
export DIGITAL_OCEAN_API_KEY="your-api-key"
```

## Common Development Tasks

### Running the Application

```bash
# Development
go run .

# Production build
go build -o app .
./app
```

### Database Operations

```bash
# Models are auto-created on first run
# Data stored in app.db by default

# Check tables
sqlite3 app.db ".tables"

# View data
sqlite3 app.db "SELECT * FROM todos;"
```

### Cloud Deployment

```bash
# Build your application
go build -o app

# Deploy using launch-app tool
export DIGITAL_OCEAN_API_KEY="your-token"
../devtools/build/launch-app --name my-server --domain app.example.com --binary ./app
```

The deployment tool will:
- Create a DigitalOcean droplet with Docker
- Upload and containerize your application
- Generate SSL certificates automatically
- Start your application with proper networking

### Adding New Features

1. **Create Model** (`models/feature.go`)
2. **Add Repository** (`models/database.go`): `var Features = database.Manage(DB, new(Feature))`
3. **Create Controller** (`controllers/features.go`) with factory function
4. **Register Controller** (`main.go`): `application.WithController(controllers.Features())`
5. **Create Templates** (`views/features.html`)

## Built-in Template Helpers

- `{{theme}}` - Current DaisyUI theme
- `{{host}}` - Host prefix for URLs  
- `{{auth.CurrentUser}}` - Current authenticated user
- `{{controllerName.MethodName}}` - Call controller methods
- `{{template "partial-name.html" .}}` - Include partials

## Security Features

The toolkit provides these security features automatically:

- **JWT Authentication** - Secure session management
- **Password Hashing** - Bcrypt with proper salt
- **CSRF Protection** - Built into forms
- **SSH Key Management** - Auto-generated for cloud access
- **Secure Cookies** - HTTPOnly with SameSite protection
- **SSL Certificates** - Automatic generation via Let's Encrypt

## Performance Features

- **Embedded Assets** - Views compiled into binary
- **Connection Pooling** - Automatic database connection management
- **WAL Mode** - SQLite3 optimized for concurrency
- **Template Caching** - Pre-compiled templates
- **HTMX Integration** - Dynamic updates without full page reloads

## Integration Libraries

The toolkit integrates seamlessly with:

- **HTMX** - Dynamic page updates without JavaScript frameworks
- **DaisyUI** - Beautiful UI components with Tailwind CSS
- **Docker** - Container management and deployment
- **DigitalOcean** - Cloud server provisioning and DNS
- **Let's Encrypt** - Automatic SSL certificate generation

## Troubleshooting

### Common Issues

1. **Port in use**: Change `PORT` environment variable
2. **Database locked**: Ensure no other instances are running
3. **Template not found**: Check file paths and unique filenames
4. **Authentication failing**: Verify `AUTH_SECRET` is set
5. **Container issues**: Ensure Docker daemon is running

### Debug Mode

```bash
export DEBUG=true
go run .
```

## CLI Tool Development

### Building DevTools

```bash
git clone https://github.com/The-Skyscape/devtools
cd devtools
make build
```

### Using CLI Tools

```bash
# Generate application
./build/create-app my-app

# Deploy to cloud  
./build/launch-app --name production --domain app.com --binary ./app
```

## Need Help?

- **DevTools Repository**: https://github.com/The-Skyscape/devtools
- **Documentation**: Check README.md and docs/ directory
- **Tutorial**: Complete walkthrough in docs/tutorial.md
- **Example**: Working application in example/ directory